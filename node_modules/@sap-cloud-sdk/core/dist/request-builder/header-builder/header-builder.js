"use strict";
/* Copyright (c) 2020 SAP SE or an SAP affiliate company. All rights reserved. */
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("@sap-cloud-sdk/util");
var rambda_1 = require("rambda");
var request_1 = require("../request");
var authorization_header_1 = require("./authorization-header");
var csrf_token_header_1 = require("./csrf-token-header");
/**
 * Create object containing all headers, including custom headers for a given  OData request configuration and destination.
 * Custom headers override duplicate headers.
 *
 * @typeparam RequestT - Type of the request the headers are built for
 * @param request - OData request configuration to create headers for
 * @returns Key-value pairs where the key is the name of a header property and the value is the respective value
 */
function buildHeaders(request) {
    if (!request.destination) {
        throw Error('The request destination is undefined.');
    }
    return buildHeadersAuthFirstCustomLast(request)(addEtagHeader(request.config), function (headers) { return csrf_token_header_1.addCsrfTokenAndCookies(request, headers); }, addAcceptHeader, function (headers) { return addContentTypeHeader(request.config.contentType, headers); }, addSapClientHeader(request.destination.sapClient || undefined), exports.addProxyHeaders(request.destination.proxyConfiguration), exports.addLocationIdHeader(request.destination.cloudConnectorLocationId));
}
exports.buildHeaders = buildHeaders;
/**
 * Builds the authorization, proxy authorization and SAP client headers for a given destination.
 *
 * @param destination - A destination.
 * @returns HTTP headers for the given destination.
 */
exports.buildHeadersForDestination = function (destination) {
    return util_1.asyncPipe(addSapClientHeader(destination.sapClient || undefined), 
    // TODO the proxy header are for OnPrem auth and are now handled correctly in the authorization-header.ts and should be removed here
    // However this would be a breaking change, since we recommended to use 'NoAuthentication' to achieve principal propagation as a workaround.
    exports.addProxyHeaders(destination.proxyConfiguration), exports.addLocationIdHeader(destination.cloudConnectorLocationId), authorization_header_1.buildAndAddAuthorizationHeader(destination))({});
};
function addSapClientHeader(sapClient) {
    return function (headers) { return util_1.assocSome('sap-client', sapClient)(headers); };
}
exports.addSapClientHeader = addSapClientHeader;
exports.addProxyHeaders = function (proxyConfiguration) { return function (headers) {
    return util_1.mergeSome(headers, rambda_1.path(['headers'], proxyConfiguration));
}; };
exports.addLocationIdHeader = function (locationId) { return function (headers) {
    return util_1.assocSome('SAP-Connectivity-SCC-Location_ID', locationId)(headers);
}; };
var buildHeadersAuthFirstCustomLast = function (request) { return function () {
    var fns = [];
    for (var _i = 0; _i < arguments.length; _i++) {
        fns[_i] = arguments[_i];
    }
    return util_1.asyncPipe.apply(void 0, __spreadArrays([function (headers) { return authorization_header_1.addAuthorizationHeader(request, headers); }], fns, [addCustomHeaders(request.config.customHeaders)]))({});
}; };
var addEtagHeader = function (requestConfig) { return function (headers) {
    return util_1.assocSome('if-match', getETagHeader(requestConfig))(headers);
}; };
var addCustomHeaders = function (customHeaders) { return function (headers) { return (__assign(__assign({}, headers), customHeaders)); }; };
var addContentTypeHeader = function (contentType, headers) { return rambda_1.assoc('Content-Type', contentType)(headers); };
var addAcceptHeader = function (headers) { return rambda_1.assoc('Accept', 'application/json')(headers); };
var eTagFromConfig = function (config) {
    return config.versionIdentifierIgnored ? '*' : config.eTag;
};
var getETagHeader = function (config) {
    return rambda_1.ifElse(function (c) { return c instanceof request_1.ODataUpdateRequestConfig || c instanceof request_1.ODataDeleteRequestConfig; }, eTagFromConfig, function () { return undefined; })(config);
};
//# sourceMappingURL=header-builder.js.map