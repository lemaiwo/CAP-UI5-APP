const { isDraftEnabled } = require('../../../../common/utils/draft')

const { addKeysToWhere, enhanceCqnWithSubSelects, isNavigation, isPathSupported } = require('./selectHelper')
const { ensureNoDraftsSuffix } = require('../../../services/utils/draftUtils')
const SUPPORTED_SEGMENT_KINDS = [
  'BOUND.ACTION',
  'BOUND.FUNCTION',
  'ENTITY',
  'ENTITY.COLLECTION',
  'NAVIGATION.TO.ONE',
  'NAVIGATION.TO.MANY',
  'PRIMITIVE.PROPERTY',
  'COUNT'
]

/**
 * Transform odata bound action or functiuon request into a CQN object.
 *
 * @param {Object} service - Service, which will process this request.
 * @param {object} context - Contains request information and utility methods like statements.
 * @param {object} req - An odata request.
 * @private
 */
const boundToCQN = (service, { statements: { SELECT }, target }, req) => {
  const segments = req.getUriInfo().getPathSegments()
  isPathSupported(SUPPORTED_SEGMENT_KINDS, segments)

  const cqn = SELECT.from(target)
  if (isNavigation(segments)) {
    enhanceCqnWithSubSelects(cqn, segments.slice(0, segments.length - 1), service.model, SELECT)
  }

  addKeysToWhere(segments, cqn, isDraftEnabled(service.model.definitions[ensureNoDraftsSuffix(target.name)]))

  return cqn
}

module.exports = boundToCQN
