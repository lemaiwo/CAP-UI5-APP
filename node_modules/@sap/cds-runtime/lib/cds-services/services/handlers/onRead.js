const {
  messages: { DB_CONNECTION_MISSING }
} = require('../utils/constants')
const { rejectSkippedEntity } = require('../utils/handlerUtils')
/**
 * Generic Handler for READ requests.
 *
 * @param context - operation object, that provides error, continuation and other functions as well as information
 * regarding the current operation.
 * @alias module:handlers.onRead
 */
const onRead = () => context => {
  if (context.query.SELECT.limit && context.query.SELECT.limit.rows && context.query.SELECT.limit.rows.val === 0) {
    return Promise.resolve([])
  }

  if (!context.run) {
    context.log.warn(DB_CONNECTION_MISSING)
    return Promise.resolve([])
  }

  if (context.target['@cds.persistence.skip'] === true) {
    rejectSkippedEntity(context)
    return
  }

  if (context._ && context._.streaming) {
    return context.run(context.query).then(val => {
      return { value: val }
    })
  }

  if (context._.validationQuery) {
    return Promise.all([context.run(context.query), context.run(context._.validationQuery)]).then(
      ([result, validationResult]) => {
        if (validationResult.length === 0) {
          return context.error(404)
        }

        return Promise.resolve(result)
      }
    )
  }

  return context.run(context.query)
}

module.exports = onRead
