import { SELECT, INSERT, UPDATE, DELETE, Query, ConstructedQuery } from './ql'
import { LinkedModel, Definitions } from '@sap/cds-reflect/apis/reflected'
import { csn, Definition } from "@sap/cds-reflect/apis/csn"

/** Class cds.Service --- instances are obtained through `cds.connect` or `cds.serve`.  */
export interface Service extends QueryAPI, ProviderAPI, MessagingAPI {

	/** The model from which the service's definition was loaded */
	model: LinkedModel

	/** Provides access to the entities exposed by a service
	 * @see [capire](https://github.wdf.sap.corp/pages/cap/node.js/api#srventities-types--namespace--defs)
	 */
	entities: Definitions & ((namespace: string) => Definitions)

	/** Provides access to the types exposed by a service
	 * @see [capire](https://github.wdf.sap.corp/pages/cap/node.js/api#srventities-types--namespace--defs)
	 */
	types: Definitions & ((namespace: string) => Definitions)

	/** Starts or joins a transation
	 * @see [capire](https://github.wdf.sap.corp/pages/cap/node.js/api#srvtransaction--context--tx)
	 */
	transaction (context : object) : Transaction
	tx (context : object) : Transaction
}

export interface Transaction extends QueryAPI {
	commit() : Promise<void>
	rollback() : Promise<void>
}

export interface Database extends Service {
	deploy (model?: csn | string) : Promise<csn>
	begin() : Promise<void>
	commit() : Promise<void>
	rollback() : Promise<void>
}

export interface ResultSet extends Array<{}> {}

export interface QueryAPI {
	read <T>(entity : Definition | string) : SELECT<T>
	insert <T>(entity : Definition | string) : INSERT<T>
	update <T>(entity : Definition | string) : UPDATE<T>
	delete <T>(entity : Definition | string) : DELETE<T>
	run (block : (tx:Transaction) => void) : Promise<ResultSet | any>
	run (query : ConstructedQuery) : Promise<ResultSet | any>
	run (query : Query) : Promise<ResultSet | any>
	foreach (query : Query, callback: (row:object) => void) : this
}

export interface ProviderAPI {
	impl (fn: ServiceImpl) : this
	on: (eve: Events, entity: Target, handler: EventHandler) => this & ((eve: Events, handler: EventHandler) => this)
	onSucceeded (eve: Events, entity?: Target, handler?: EventHandler) : this
	onFailed (eve: Events, entity?: Target, handler?: EventHandler) : this
	before (eve: Events, entity?: Target, handler?: EventHandler) : this
	after (eve: Events, entity?: Target, handler?: ResultsHandler) : this
	reject (eves: Events, ...entity: Target[]) : this
	dispatch (msg : EventMessage) : any
}

export interface MessagingAPI {
	emit (eve: Events, entity: Target, data?: object) : this
	emit (eve: Events, data?: object) : this
}

export interface ServiceImpl {
	( this: Service, srv: Service ) : any
}

export interface EventHandler {
	// (msg : EventMessage) : Promise<any> | any | void
	(req : Request) : Promise<any> | any | void
}

interface ResultsHandler {
	(results : any[]) : void
	(each : any) : void
}

interface EventMessage {
	event : string
	data : any
}

interface Request extends EventMessage {
	target : Definition
	query : Query
	reply() : void
	error() : void
	reject() : void
}

type Events = Event | Event[]
type Event = ( CRUD | TX | HTTP | DRAFT ) & CustomOp
type CRUD = 'CREATE' | 'READ' | 'UPDATE' | 'DELETE'
type DRAFT = 'NEW' | 'EDIT' | 'PATCH' | 'SAVE'
type HTTP = 'GET' | 'PUT' | 'POST' | 'PATCH' | 'DELETE'
type TX = 'COMMIT' | 'ROLLBACK'
type CustomOp = string
type Target = string | Definition
