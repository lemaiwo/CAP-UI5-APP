const fs = require('@sap/cds-foss')('fs-extra')
const path = require('path')
const BuildTaskHandlerOData = require('../buildTaskHandlerOData')
const { BUILD_OPTION_OUTPUT_MODE, OUTPUT_MODE_RESULT_ONLY, FILE_EXT_CDS } = require('../constants')
const DEBUG = process.env.DEBUG

const DEFAULT_COMPILE_DEST_FOLDER = path.normalize("src/main/resources/edmx")

class JavaCfModuleBuilder extends BuildTaskHandlerOData {
    constructor(task, buildOptions) {
        super("Java CF Module Builder", task, buildOptions)
    }

    init() {
        this.task.options.compileDest = path.resolve(this.task.dest, this.task.options.compileDest || DEFAULT_COMPILE_DEST_FOLDER)
    }

    async build() {
        const modelPaths = this.resolveModel()
        const { src, dest } = this.task

        this.logger.log(`\n[cds] - building module [${this.stripProjectPaths(src)}] using [${this.name}]`)

        if (!modelPaths || modelPaths.length === 0) {
            this.logger.log(`[cds] - no model found, skip build`)
            return this._result
        }
        if (DEBUG) {
            this.logger.log(`[cds] - model: ${this.stripProjectPaths(modelPaths).join(", ")}`)
        }

        // compile to csn
        const options = this.options()
        const model = await this.cds.load(modelPaths, options)
        this.pushMessages(options.messages || options._messages)

        const promises = [
            this.compileCsn(model, this.task.options.compileDest),
            this.compileEdmx(model, this.task.options.compileDest)
        ]

        if (!this.hasBuildOption(BUILD_OPTION_OUTPUT_MODE, OUTPUT_MODE_RESULT_ONLY)) {
            promises.push(this._copyNativeContent(src, dest))
        }
        await Promise.all(promises)

        return this._result
    }

    async clean() {
        if (this.isStagingBuild()) {
            await super.clean()
            return
        }
        if (DEBUG) {
            this.logger.log(`Deleting build target folder ${this.task.options.compileDest}`)
        }
        await fs.remove(this.task.options.compileDest)
    }

    async _copyNativeContent(src, dest) {
        return super.copyNativeContent(src, dest, (entry) => {
            if (fs.statSync(entry).isDirectory()) {
                return true // using common filter for folders
            } else {
                const extname = path.extname(entry)
                return extname !== FILE_EXT_CDS
            }
        })
    }
}
module.exports = JavaCfModuleBuilder
